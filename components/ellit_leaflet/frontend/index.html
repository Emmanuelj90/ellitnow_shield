<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <script src="https://unpkg.com/@streamlit/component-lib/dist/main.js"></script>

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    />

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <style>
      #map {
        width: 100%;
        height: 500px;
      }
    </style>
  </head>

  <body>
    <div id="map"></div>

    <script>
      class EllitMap extends StreamlitComponentBase {
        onRender(event) {
          const data = event.detail.args.data;

          // Si el mapa ya existe, evitar recrearlo
          if (this._map) {
            this.updateMarkers(data);
            return;
          }

          // Crear mapa
          this._map = L.map("map").setView([20, 0], 2);

          L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 6,
          }).addTo(this._map);

          this.updateMarkers(data);

          Streamlit.setFrameHeight(550);
        }

        updateMarkers(data) {
          if (!data || !data.countries) return;

          // Eliminar marcadores previos
          if (this._markers) {
            this._markers.forEach((m) => this._map.removeLayer(m));
          }

          this._markers = [];

          data.countries.forEach((c) => {
            const marker = L.marker([c.lat, c.lng]).addTo(this._map);
            marker.bindPopup(
              `<b>${c.country}</b><br/>Riesgo: ${c.risk}<br/>CVEs: ${c.cves}`
            );

            this._markers.push(marker);
          });
        }
      }

      Streamlit.mount(EllitMap);
    </script>
  </body>
</html>
