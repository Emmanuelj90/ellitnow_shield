<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Ellit Leaflet Map</title>

    <!-- Leaflet CSS -->
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .marker-popup {
            font-size: 14px;
            line-height: 1.4;
        }
    </style>
</head>

<body>
    <div id="map"></div>

    <script>
        // Inicializa mapa
        var map = L.map("map").setView([20, 0], 2);

        // Capa base
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 18
        }).addTo(map);

        // SO: Streamlit Injected Data Handler
        function renderThreatMap(threatData) {
            if (!threatData || !threatData.countries) return;

            threatData.countries.forEach(country => {
                const popupContent = `
                    <div class="marker-popup">
                        <b>${country.country}</b><br>
                        Riesgo: ${country.risk}%<br>
                        CVEs: ${country.cves}<br>
                        Ransomware: ${country.ransomware}<br>
                        Cadena Suministro: ${country.supply_chain}<br>
                        Cr√≠ticos: ${country.critical}
                    </div>
                `;

                L.marker([country.lat, country.lng])
                    .addTo(map)
                    .bindPopup(popupContent);
            });
        }

        // Este callback lo usa Streamlit
        window.streamlitComponent = {
            onRender: function(data) {
                try {
                    if (typeof data.threatData === "string") {
                        renderThreatMap(JSON.parse(data.threatData));
                    } else {
                        renderThreatMap(data.threatData);
                    }
                } catch (e) {
                    console.error("Error parsing threatData", e);
                }
            }
        };
    </script>
</body>
</html>
